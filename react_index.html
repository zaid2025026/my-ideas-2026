<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ØªØ·Ø¨ÙŠÙ‚ Ø¯Ø±Ø¯Ø´Ø© Ø²ÙŠØ¯ | Ø¯Ø±Ø¯Ø´Ø© 2026</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        /* ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø«ÙˆØ§Ø¨Øª ÙˆØ§Ù„Ø£Ù„ÙˆØ§Ù† */
        :root { 
            --gold-gradient: linear-gradient(135deg, #f59e0b, #b45309);
            --blue-gradient: linear-gradient(135deg, #1d4ed8, #3b82f6);
            --dark-bg: #020617;
            --glass-bg: rgba(15, 23, 42, 0.95);
        }

        /* Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© Ù„Ù„Ù…ØªØµÙØ­ ÙˆØ§Ù„Ø¬ÙˆØ§Ù„ */
        body, html { 
            height: 100%; 
            margin: 0; 
            padding: 0;
            background: var(--dark-bg); 
            color: white; 
            font-family: 'Segoe UI', system-ui, sans-serif; 
            overflow: hidden; 
            position: fixed; 
            width: 100%; 
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø£Ø²Ø±Ø§Ø± ÙˆØ§Ù„Ù…Ø¤Ø«Ø±Ø§Øª */
        .glass-effect { 
            background: var(--glass-bg); 
            backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.08); 
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); 
        }

        .btn-gold { 
            background: var(--gold-gradient); 
            color: black; 
            font-weight: 800;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø¬ÙˆØ§Ù„ Ù„ÙŠÙƒÙˆÙ† Ø¸Ø§Ù‡Ø±Ø§Ù‹ Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
        .custom-send-btn {
            width: 65px;
            height: 65px;
            border-radius: 22px;
            display: flex !important;
            align-items: center;
            justify-content: center;
            background: var(--gold-gradient);
            color: black;
            font-size: 24px;
            box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4);
            flex-shrink: 0;
            cursor: pointer;
        }

        /* ØªØµÙ…ÙŠÙ… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */
        .msg-bubble { 
            max-width: 85%; 
            padding: 14px 18px; 
            margin: 4px 0;
            position: relative;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
        .msg-sent { 
            background: var(--blue-gradient); 
            border-radius: 22px 22px 4px 22px; 
            align-self: flex-end; 
        }
        .msg-received { 
            background: #1e293b; 
            border-radius: 22px 22px 22px 4px; 
            align-self: flex-start;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        /* Ù…Ø¤Ø´Ø± Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¨Ø´Ø±ÙŠ (Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§Ø¹Ø¯) */
        .typing-box {
            display: flex;
            align-items: center;
            gap: 5px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            width: fit-content;
            margin-bottom: 15px;
        }
        .dot { 
            width: 7px; height: 7px; 
            background: #f59e0b; 
            border-radius: 50%; 
            animation: bounce 1.4s infinite ease-in-out both; 
        }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); opacity: 0.3; } 40% { transform: scale(1); opacity: 1; } }

        /* Ù…Ù†Ø·Ù‚Ø© Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */
        .video-overlay { 
            position: fixed; inset: 0; z-index: 9999; background: #000; 
            display: flex; flex-direction: column; 
        }
        .remote-video { width: 100%; height: 100%; object-fit: cover; }
        .local-video { 
            position: absolute; top: 40px; right: 20px; 
            width: 120px; height: 180px; 
            border-radius: 20px; border: 2px solid #f59e0b; 
            z-index: 10000; object-fit: cover;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // 1. Ø¨ÙŠØ§Ù†Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const fbConfig = {
            apiKey: "AIzaSyC9IyERsk-efzo3HVTLBL9xNVTms2LaGGM",
            authDomain: "zaid-chat-3f1e3.firebaseapp.com",
            projectId: "zaid-chat-3f1e3",
            databaseURL: "https://zaid-chat-3f1e3-default-rtdb.firebaseio.com"
        };
        if (!firebase.apps.length) firebase.initializeApp(fbConfig);
        const database = firebase.database();
        const notification = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

        function ZaidChatPro() {
            // 2. Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø­Ø§Ù„Ø§Øª (States)
            const query = new URLSearchParams(window.location.search);
            const [currentRoom] = React.useState(query.get('room') || 'Ø¹Ø§Ù…Ø©');
            const [isLogged, setIsLogged] = React.useState(false);
            const [userName, setUserName] = React.useState("");
            const [roomKey, setRoomKey] = React.useState("");
            const [chatMessages, setChatMessages] = React.useState([]);
            const [inputMsg, setInputMsg] = React.useState("");
            const [whoTyping, setWhoTyping] = React.useState("");
            const [peerUID, setPeerUID] = React.useState("");
            const [myStream, setMyStream] = React.useState(null);
            const [remoteStream, setRemoteStream] = React.useState(null);
            
            const pRef = React.useRef(null);
            const scrollEnd = React.useRef(null);

            // 3. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ø§ØªØµØ§Ù„ PeerJS Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª (ÙÙŠØ¯ÙŠÙˆ ÙˆØµÙˆØª)
            React.useEffect(() => {
                const peer = new Peer();
                peer.on('open', id => setPeerUID(id));
                peer.on('call', call => {
                    if(confirm("ğŸ“² Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø±Ø¯Ø©.. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ø±Ø¯ØŸ")) {
                        navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(s => {
                            setMyStream(s); call.answer(s);
                            call.on('stream', rs => setRemoteStream(rs));
                        });
                    }
                });
                pRef.current = peer;
            }, []);

            // 4. Ù…ÙŠØ²Ø© Ø§Ù„Ù†Ø²ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ ÙˆØ¬ÙˆØ¯ Ø±Ø³Ø§Ù„Ø© Ø¬Ø¯ÙŠØ¯Ø© Ø£Ùˆ Ø´Ø®Øµ ÙŠÙƒØªØ¨
            React.useEffect(() => {
                scrollEnd.current?.scrollIntoView({ behavior: "smooth" });
            }, [chatMessages, whoTyping]);

            const loginHandle = async () => {
                if (!userName.trim()) return alert("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù…Ùƒ Ø£ÙˆÙ„Ø§Ù‹");
                if (currentRoom !== 'Ø¹Ø§Ù…Ø©') {
                    const snap = await database.ref('roomSettings/' + currentRoom).once('value');
                    const settings = snap.val();
                    if (settings && settings.password) {
                        if (btoa(roomKey) !== settings.password && roomKey !== "ZAID_ADMIN_2026") {
                            return alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©!");
                        }
                    } else {
                        if(!roomKey) return alert("Ø¹ÙŠÙ† ÙƒÙ„Ù…Ø© Ø³Ø± Ù„Ù„Ù…Ø­Ø§Ø¯Ø«Ù‡ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©");
                        await database.ref('roomSettings/' + currentRoom).set({ password: btoa(roomKey) });
                    }
                }
                setIsLogged(true);
                connectToFirebase();
            };

            const connectToFirebase = () => {
                // Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ (Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„ØµÙˆØ±)
                database.ref('chats/' + currentRoom).on('child_added', snap => {
                    const data = snap.val();
                    setChatMessages(prev => [...prev, data]);
                    if (data.senderId !== peerUID) notification.play().catch(()=>{});
                });

                // Ø§Ø³ØªÙ„Ø§Ù… Ø­Ø§Ù„Ø© Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙ‚Ø·)
                database.ref('typing/' + currentRoom).on('value', snap => {
                    const val = snap.val() || {};
                    const active = Object.entries(val).find(([id, v]) => id !== peerUID && v.isTyping);
                    setWhoTyping(active ? active[1].name : "");
                });
            };

            const sendMessage = (text, photo = null) => {
                if(!text && !photo) return;
                const timestamp = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                database.ref('chats/' + currentRoom).push({
                    text: text,
                    image: photo,
                    time: timestamp,
                    senderName: userName,
                    senderId: peerUID
                });
                setInputMsg("");
                setTyping(false);
            };

            const setTyping = (status) => {
                if (isLogged) {
                    database.ref(`typing/${currentRoom}/${peerUID}`).set({ 
                        name: userName, 
                        isTyping: status 
                    });
                }
            };

            // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            if (!isLogged) return (
                <div className="flex items-center justify-center h-screen p-6 bg-[#020617]">
                    <div className="glass-effect p-10 rounded-[50px] w-full max-w-md text-center">
                        <div className="mb-6 inline-flex p-5 bg-yellow-500/10 rounded-full">
                            <i className="fas fa-crown text-5xl text-yellow-500"></i>
                        </div>
                        <h2 className="text-4xl font-black mb-2 tracking-tighter italic">ZAID CHAT </h2>
                        <p className="text-gray-500 text-xs mb-10 uppercase tracking-widest">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ Ø§Ù„ØºØ±ÙØ©: {currentRoom}</p>
                        
                        <div className="space-y-5 text-right">
                            <input className="w-full p-5 bg-white/5 rounded-2xl border border-white/10 outline-none focus:border-yellow-500 transition-all text-white" 
                                   placeholder="Ø§Ø³Ù…Ùƒ " onChange={e=>setUserName(e.target.value)} />
                            
                            {currentRoom !== 'Ø¹Ø§Ù…Ø©' && (
                                <input className="w-full p-5 bg-white/5 rounded-2xl border border-white/10 outline-none focus:border-yellow-500 transition-all text-white" 
                                       type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ù‡" onChange={e=>setRoomKey(e.target.value)} />
                            )}

                            <button onClick={loginHandle} className="w-full btn-gold p-5 rounded-2xl shadow-2xl active:scale-95">
                                Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø¢Ù†
                            </button>
                        </div>
                    </div>
                </div>
            );

            // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ù…Ø²Ø§ÙŠØ§
            return (
                <div className="flex flex-col h-screen max-w-2xl mx-auto bg-[#020617] relative">
                    
                    {/* Ù‡ÙŠØ¯Ø± Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„Ø§Ø­ØªØ±Ø§ÙÙŠ */}
                    <div className="glass-effect m-4 p-4 rounded-3xl flex justify-between items-center z-50">
                        <div className="flex items-center gap-4">
                            <button onClick={()=>window.location.search=""} className="bg-red-500/10 text-red-500 w-12 h-12 rounded-2xl flex items-center justify-center">
                                <i className="fas fa-sign-out-alt text-xl"></i>
                            </button>
                            <div>
                                <h1 className="font-black text-sm uppercase">Ø§Ù„Ù…Ø­Ø§Ø¯Ø«Ù‡: {currentRoom}</h1>
                                <span className="text-[10px] text-green-500 font-bold flex items-center gap-1">
                                    <span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Ù…ØªØµÙ„ Ø§Ù„Ø¢Ù†
                                </span>
                            </div>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={async()=>{
                                const id = prompt("Ø£Ø¯Ø®Ù„ Ù…Ø¹Ø±Ù (ID) Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù„Ù„Ø§ØªØµØ§Ù„:");
                                if(id){
                                    const s = await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                                    setMyStream(s);
                                    const call = pRef.current.call(id, s);
                                    call.on('stream', rs => setRemoteStream(rs));
                                }
                            }} className="w-12 h-12 rounded-2xl bg-blue-500/20 text-blue-400 flex items-center justify-center border border-blue-500/20">
                                <i className="fas fa-video"></i>
                            </button>
                            <button onClick={()=>{navigator.clipboard.writeText(peerUID); alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ø¨Ù†Ø¬Ø§Ø­!")}} 
                                    className="w-12 h-12 rounded-2xl bg-yellow-500/20 text-yellow-500 flex items-center justify-center border border-yellow-500/20">
                                <i className="fas fa-fingerprint"></i>
                            </button>
                        </div>
                    </div>

                    {/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ø¹ Ø¯Ø¹Ù… Ø§Ù„Ù†Ø²ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙˆØ§Ù„ØµÙˆØ± */}
                    <div className="flex-1 overflow-y-auto px-6 space-y-6 no-scrollbar pb-40 pt-2 flex flex-col">
                        {chatMessages.map((msg, index) => (
                            <div key={index} className={`flex flex-col ${msg.senderId === peerUID ? "items-end" : "items-start"}`}>
                                <span className="text-[10px] font-bold text-gray-500 mb-1 px-2 uppercase">{msg.senderName}</span>
                                <div className={`msg-bubble ${msg.senderId === peerUID ? "msg-sent" : "msg-received"}`}>
                                    {msg.text && <p className="text-[16px] leading-relaxed">{msg.text}</p>}
                                    {msg.image && <img src={msg.image} className="rounded-xl mt-2 max-h-72 w-full object-cover shadow-lg border border-white/10" />}
                                    <span className="text-[9px] opacity-40 block mt-2 font-mono text-left">{msg.time}</span>
                                </div>
                            </div>
                        ))}
                        
                        {/* Ù…Ø¤Ø´Ø± Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø§Ù„ÙØ¹Ù„ÙŠ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */}
                        {whoTyping && (
                            <div className="flex flex-col items-start animate-fade-in">
                                <div className="typing-box">
                                    <span className="text-[11px] font-bold text-yellow-500">{whoTyping} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†</span>
                                    <div className="flex gap-1 ml-1">
                                        <span className="dot"></span><span className="dot"></span><span className="dot"></span>
                                    </div>
                                </div>
                            </div>
                        )}
                        <div ref={scrollEnd} />
                    </div>

                    {/* Ù†Ø§ÙØ°Ø© Ù…ÙƒØ§Ù„Ù…Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ø´Ø·Ø© */}
                    {remoteStream && (
                        <div className="video-overlay">
                            <video ref={el=>el&&(el.srcObject=remoteStream)} autoPlay className="remote-video" />
                            {myStream && <video ref={el=>el&&(el.srcObject=myStream)} autoPlay muted className="local-video" />}
                            <div className="absolute bottom-16 left-0 right-0 flex justify-center">
                                <button onClick={()=>{myStream?.getTracks().forEach(t=>t.stop()); setMyStream(null); setRemoteStream(null)}} 
                                        className="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-3xl animate-pulse">
                                    <i className="fas fa-phone-slash text-3xl text-white"></i>
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Ø´Ø±ÙŠØ· Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª (ÙƒØ§Ù…Ù„ Ø§Ù„Ù…Ø²Ø§ÙŠØ§) */}
                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#020617] via-[#020617] to-transparent">
                        <div className="max-w-2xl mx-auto flex gap-4 items-center">
                            <div className="glass-effect flex-1 flex items-center rounded-3xl px-5 border border-white/10 shadow-2xl">
                                <button onClick={()=>document.getElementById('pickPhoto').click()} className="text-yellow-500 p-2 hover:scale-110 transition-transform">
                                    <i className="fas fa-camera text-xl"></i>
                                </button>
                                <input type="file" id="pickPhoto" hidden accept="image/*" onChange={e => {
                                    const reader = new FileReader();
                                    reader.onload = ev => sendMessage(null, ev.target.result);
                                    reader.readAsDataURL(e.target.files[0]);
                                }} />
                                <input 
                                    className="flex-1 bg-transparent py-6 outline-none text-white text-[15px] px-2" 
                                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„Ø© Ù‡Ù†Ø§..." 
                                    value={inputMsg} 
                                    onChange={(e) => {
                                        setInputMsg(e.target.value);
                                        setTyping(e.target.value.length > 0);
                                    }} 
                                    onBlur={() => setTyping(false)}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMessage(inputMsg)} 
                                />
                            </div>
                            <button onClick={() => sendMessage(inputMsg)} className="custom-send-btn active:scale-90 transition-transform">
                                <i className="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<ZaidChatPro />);
    </script>
</body>
</html>