<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zaid Chat Ultimate Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --gold: #f59e0b; --blue: #3b82f6; --dark: #020617; }
        body, html { height: 100%; margin: 0; background: var(--dark); color: white; font-family: system-ui; overflow: hidden; position: fixed; width: 100%; }
        
        .glass { background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.1); }
        .chat-scroll { height: calc(100% - 175px); overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        .bubble { max-width: 85%; padding: 15px; position: relative; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .bubble-me { background: linear-gradient(135deg, #1d4ed8, #3b82f6); border-radius: 25px 25px 5px 25px; align-self: flex-end; }
        .bubble-other { background: #1e293b; border-radius: 25px 25px 25px 5px; align-self: flex-start; border: 1px solid rgba(255,255,255,0.05); }

        .btn-main { background: linear-gradient(135deg, #f59e0b, #d97706); color: black; font-weight: 900; cursor: pointer; transition: 0.3s; }
        .btn-main:active { transform: scale(0.95); }
        
        .send-pill { width: 65px; height: 65px; border-radius: 22px; background: var(--gold); color: black; display: flex !important; align-items: center; justify-content: center; font-size: 24px; box-shadow: 0 10px 25px rgba(245, 158, 11, 0.4); flex-shrink: 0; }

        .typing-box { display: flex; align-items: center; gap: 6px; padding: 10px 15px; background: rgba(255,255,255,0.05); border-radius: 20px; width: fit-content; margin-bottom: 10px; }
        .dot { width: 6px; height: 6px; background: var(--gold); border-radius: 50%; animation: bounce 1.4s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes bounce { 0%, 80%, 100% { transform: scale(0); } 40% { transform: scale(1); } }

        .video-fs { position: fixed; inset: 0; z-index: 9999; background: #000; }
        .v-remote { width: 100%; height: 100%; object-fit: cover; }
        .v-local { position: absolute; top: 30px; right: 20px; width: 110px; height: 160px; border-radius: 20px; border: 2px solid var(--gold); object-fit: cover; z-index: 10000; }

        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const firebaseConfig = {
            apiKey: "AIzaSyC9IyERsk-efzo3HVTLBL9xNVTms2LaGGM",
            authDomain: "zaid-chat-3f1e3.firebaseapp.com",
            projectId: "zaid-chat-3f1e3",
            databaseURL: "https://zaid-chat-3f1e3-default-rtdb.firebaseio.com"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const notification = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

        function App() {
            const [page, setPage] = React.useState("login"); 
            const [room, setRoom] = React.useState(new URLSearchParams(window.location.search).get('room') || 'Ø¹Ø§Ù…Ø©');
            const [name, setName] = React.useState("");
            const [pass, setPass] = React.useState("");
            const [msgs, setMsgs] = React.useState([]);
            const [text, setText] = React.useState("");
            const [typer, setTyper] = React.useState("");
            const [myId, setMyId] = React.useState("");
            const [stream, setStream] = React.useState(null);
            const [remote, setRemote] = React.useState(null);
            
            const peerRef = React.useRef(null);
            const scrollRef = React.useRef(null);

            React.useEffect(() => {
                const peer = new Peer();
                peer.on('open', id => setMyId(id));
                peer.on('call', call => {
                    if(confirm("ğŸ“² Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø±Ø¯Ø©.. Ù‡Ù„ ØªÙ‚Ø¨Ù„ØŸ")) {
                        navigator.mediaDevices.getUserMedia({video:true, audio:true}).then(s => {
                            setStream(s); call.answer(s);
                            call.on('stream', rs => setRemote(rs));
                        });
                    }
                });
                peerRef.current = peer;
            }, []);

            React.useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [msgs, typer]);

            const handleEnter = async () => {
                if (!name.trim()) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø§Ø³Ù…");
                if (room !== 'Ø¹Ø§Ù…Ø©') {
                    const snap = await db.ref('roomSettings/' + room).once('value');
                    const config = snap.val();
                    if (config && config.password) {
                        if (btoa(pass) !== config.password && pass !== "ZAID_ADMIN_2026") return alert("ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©");
                    } else if (pass) {
                        await db.ref('roomSettings/' + room).set({ password: btoa(pass) });
                    }
                }
                setPage("chat");
                startSync();
            };

            const startSync = () => {
                db.ref('chats/' + room).on('child_added', s => {
                    const m = s.val();
                    setMsgs(prev => [...prev, m]);
                    if (m.senderId !== myId) notification.play().catch(()=>{});
                });
                db.ref('typing/' + room).on('value', s => {
                    const data = s.val() || {};
                    const active = Object.entries(data).find(([id, v]) => id !== myId && v.isTyping);
                    setTyper(active ? active[1].name : "");
                });
            };

            const send = (txt, img = null) => {
                if(!txt && !img) return;
                const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                db.ref('chats/' + room).push({ text: txt, image: img, time, senderName: name, senderId: myId });
                setText("");
                updateTyping(false);
            };

            const updateTyping = (isTyping) => {
                db.ref(`typing/${room}/${myId}`).set({ name, isTyping });
            };

            // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ØµÙ„ÙŠØ©
            if (page === "login") return (
                <div className="flex items-center justify-center h-screen p-6">
                    <div className="glass p-10 rounded-[50px] w-full max-w-sm text-center">
                        <i className="fas fa-crown text-5xl text-yellow-500 mb-6"></i>
                        <h2 className="text-3xl font-black mb-1 uppercase tracking-tighter">Zaid Chat Pro</h2>
                        <p className="text-gray-500 text-[10px] mb-8 uppercase tracking-widest tracking-tighter">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„ØºØ±ÙØ©: {room}</p>
                        <input className="w-full p-5 bg-white/5 rounded-2xl mb-4 border border-white/10 outline-none text-white focus:border-yellow-500" placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±" onChange={e=>setName(e.target.value)} />
                        <input className="w-full p-5 bg-white/5 rounded-2xl mb-4 border border-white/10 outline-none text-white focus:border-yellow-500" type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØºØ±ÙØ©" onChange={e=>setPass(e.target.value)} />
                        <button onClick={handleEnter} className="w-full btn-main p-5 rounded-2xl text-lg mb-6">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
                        <button onClick={() => {
                            const n = prompt("Ø§Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                            if(n) window.location.search = `?room=${encodeURIComponent(n)}`;
                        }} className="text-blue-400 text-sm font-bold flex items-center justify-center gap-2 w-full">
                            <i className="fas fa-plus-circle"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Ø¨ÙƒÙ„Ù…Ø© Ø³Ø±
                        </button>
                    </div>
                </div>
            );

            // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø© Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ø§Ù„Ù…Ø²Ø§ÙŠØ§
            return (
                <div className="flex flex-col h-screen max-w-lg mx-auto bg-[#020617] relative">
                    <div className="glass m-4 p-4 rounded-3xl flex justify-between items-center z-50">
                        <button onClick={()=>window.location.search=""} className="bg-red-500/20 text-red-500 w-11 h-11 rounded-2xl flex items-center justify-center"><i className="fas fa-power-off"></i></button>
                        <div className="text-center">
                            <h1 className="font-bold text-sm uppercase">{room}</h1>
                            <span className="text-[10px] text-green-500 font-bold flex items-center gap-1"><span className="w-1.5 h-1.5 bg-green-500 rounded-full animate-pulse"></span> Ù…ØªØµÙ„</span>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={async()=>{
                                const id=prompt("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø±:");
                                if(id){
                                    const s=await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                                    setStream(s); const call=peerRef.current.call(id, s);
                                    call.on('stream', rs=>setRemote(rs));
                                }
                            }} className="w-11 h-11 rounded-2xl bg-blue-500/20 text-blue-400 flex items-center justify-center"><i className="fas fa-video"></i></button>
                            <button onClick={()=>{navigator.clipboard.writeText(myId); alert("ØªÙ… Ù†Ø³Ø® Ø§Ù„Ù…Ø¹Ø±Ù Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ!")}} className="w-11 h-11 rounded-2xl bg-yellow-500/20 text-yellow-500 flex items-center justify-center"><i className="fas fa-fingerprint"></i></button>
                        </div>
                    </div>

                    <div className="flex-1 chat-scroll no-scrollbar pb-40 flex flex-col">
                        {msgs.map((m, i) => (
                            <div key={i} className={`flex flex-col ${m.senderId === myId ? "items-end" : "items-start"}`}>
                                <span className="text-[10px] font-bold text-gray-500 mb-1 px-1">{m.senderName}</span>
                                <div className={`bubble ${m.senderId === myId ? "bubble-me" : "bubble-other"}`}>
                                    {m.text && <p className="text-[16px] leading-relaxed">{m.text}</p>}
                                    {m.image && <img src={m.image} className="rounded-xl mt-2 max-h-72 w-full object-cover shadow-lg border border-white/10" />}
                                    <span className="text-[8px] opacity-40 block mt-2 text-left">{m.time}</span>
                                </div>
                            </div>
                        ))}
                        {typer && (
                            <div className="typing-box">
                                <span className="text-[11px] font-bold text-yellow-500">{typer} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†</span>
                                <div className="flex gap-1 mt-1 ml-1"><span className="dot"></span><span className="dot"></span><span className="dot"></span></div>
                            </div>
                        )}
                        <div ref={scrollRef} />
                    </div>

                    {remote && (
                        <div className="video-fs">
                            <video ref={el=>el&&(el.srcObject=remote)} autoPlay className="v-remote" />
                            {stream && <video ref={el=>el&&(el.srcObject=stream)} autoPlay muted className="v-local" />}
                            <div className="absolute bottom-12 left-1/2 -translate-x-1/2">
                                <button onClick={()=>{stream?.getTracks().forEach(t=>t.stop()); setStream(null); setRemote(null)}} className="w-20 h-20 bg-red-600 rounded-full flex items-center justify-center shadow-3xl animate-pulse"><i className="fas fa-phone-slash text-3xl"></i></button>
                            </div>
                        </div>
                    )}

                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#020617] via-[#020617] to-transparent">
                        <div className="max-w-lg mx-auto flex gap-4 items-center">
                            <div className="glass flex-1 flex items-center rounded-3xl px-5 border border-white/10 shadow-2xl">
                                <button onClick={()=>document.getElementById('img-input').click()} className="text-yellow-500 text-xl hover:scale-110 transition-transform"><i className="fas fa-camera"></i></button>
                                <input type="file" id="img-input" hidden accept="image/*" onChange={e=>{
                                    const r=new FileReader(); r.onload=ev=>send(null, ev.target.result); r.readAsDataURL(e.target.files[0]);
                                }} />
                                <input className="flex-1 bg-transparent py-6 outline-none text-white text-[15px] px-4" placeholder="Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„Ù…Ù„ÙƒÙŠØ©..." value={text} 
                                       onChange={e=>{setText(e.target.value); updateTyping(e.target.value.length>0)}} 
                                       onBlur={()=>updateTyping(false)} onKeyPress={e=>e.key==='Enter'&&send(text)} />
                            </div>
                            <button onClick={()=>send(text)} className="send-pill"><i className="fas fa-paper-plane"></i></button>
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>