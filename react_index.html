<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Zaid Chat Pro | Ø§Ù„Ù†Ø³Ø®Ø© Ø§Ù„Ù…Ù„ÙƒÙŠØ© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        :root { --gold: #f59e0b; --blue: #3b82f6; --dark: #020617; --glass: rgba(15, 23, 42, 0.95); }
        body, html { height: 100%; margin: 0; background: var(--dark); color: white; font-family: system-ui; overflow: hidden; position: fixed; width: 100%; }
        
        .glass-panel { background: var(--glass); backdrop-filter: blur(25px); border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 10px 40px rgba(0,0,0,0.7); }
        .my-msg { background: linear-gradient(135deg, #1d4ed8, #2563eb); border-radius: 20px 20px 4px 20px; align-self: flex-end; box-shadow: 0 5px 15px rgba(29, 78, 216, 0.3); }
        .other-msg { background: #1e293b; border-radius: 20px 20px 20px 4px; align-self: flex-start; border: 1px solid rgba(255,255,255,0.05); }
        
        /* Ø²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø°Ù‡Ø¨ÙŠ Ø§Ù„Ø¸Ø§Ù‡Ø± Ø¯Ø§Ø¦Ù…Ø§Ù‹ */
        .send-btn-fixed { min-width: 60px; height: 60px; background: linear-gradient(135deg, #f59e0b, #b45309); border-radius: 18px; display: flex !important; align-items: center; justify-content: center; color: black; box-shadow: 0 8px 20px rgba(245, 158, 11, 0.3); transition: 0.2s; z-index: 100; }
        .send-btn-fixed:active { transform: scale(0.9); }

        /* Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© */
        .dot { width: 5px; height: 5px; background: var(--gold); border-radius: 50%; display: inline-block; animation: wave 1.3s infinite ease-in-out; }
        .dot:nth-child(2) { animation-delay: 0.2s; }
        .dot:nth-child(3) { animation-delay: 0.4s; }
        @keyframes wave { 0%, 60%, 100% { transform: translateY(0); } 30% { transform: translateY(-5px); } }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .video-overlay { position: fixed; inset: 0; z-index: 9999; background: black; }
        .user-preview { position: absolute; top: 20px; right: 20px; width: 110px; height: 160px; border: 2px solid var(--gold); border-radius: 15px; z-index: 10000; object-fit: cover; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // ØªÙ‡ÙŠØ¦Ø© Firebase - Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø£ØµÙ„ÙŠØ©
        const firebaseConfig = {
            apiKey: "AIzaSyC9IyERsk-efzo3HVTLBL9xNVTms2LaGGM",
            authDomain: "zaid-chat-3f1e3.firebaseapp.com",
            projectId: "zaid-chat-3f1e3",
            databaseURL: "https://zaid-chat-3f1e3-default-rtdb.firebaseio.com"
        };
        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const notificationSound = new Audio('https://assets.mixkit.co/active_storage/sfx/2354/2354-preview.mp3');

        function App() {
            const urlParams = new URLSearchParams(window.location.search);
            const [roomId, setRoomId] = React.useState(urlParams.get('room') || 'Ø¹Ø§Ù…Ø©');
            const [isLoggedIn, setIsLoggedIn] = React.useState(false);
            const [myName, setMyName] = React.useState("");
            const [roomPass, setRoomPass] = React.useState("");
            const [messages, setMessages] = React.useState([]);
            const [inputValue, setInputValue] = React.useState("");
            const [typer, setTyper] = React.useState(""); // Ø§Ø³Ù… Ø§Ù„Ø´Ø®Øµ Ø§Ù„Ø°ÙŠ ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†
            const [myPeerId, setMyPeerId] = React.useState("");
            const [stream, setStream] = React.useState(null);
            const [remoteStream, setRemoteStream] = React.useState(null);
            
            const peerRef = React.useRef(null);
            const scrollRef = React.useRef(null);

            // Ø¥Ø¹Ø¯Ø§Ø¯ PeerJS Ù„Ù„Ù…ÙƒØ§Ù„Ù…Ø§Øª
            React.useEffect(() => {
                const peer = new Peer();
                peer.on('open', id => setMyPeerId(id));
                peer.on('call', call => {
                    if(confirm("ğŸ“² Ù…ÙƒØ§Ù„Ù…Ø© ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø±Ø¯Ø©.. Ù‡Ù„ ØªÙ‚Ø¨Ù„ØŸ")) {
                        navigator.mediaDevices.getUserMedia({video: true, audio: true}).then(s => {
                            setStream(s); call.answer(s);
                            call.on('stream', rs => setRemoteStream(rs));
                        });
                    }
                });
                peerRef.current = peer;
            }, []);

            // Ø§Ù„Ù†Ø²ÙˆÙ„ Ø§Ù„ØªÙ„Ù‚Ø§Ø¦ÙŠ Ù„Ø¢Ø®Ø± Ø±Ø³Ø§Ù„Ø©
            React.useEffect(() => {
                scrollRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [messages, typer]);

            const handleLogin = async () => {
                if (!myName.trim()) return alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±");
                if (roomId !== 'Ø¹Ø§Ù…Ø©') {
                    const snap = await db.ref('roomSettings/' + roomId).once('value');
                    const config = snap.val();
                    if (config && config.password) {
                        if (btoa(roomPass) !== config.password && roomPass !== "ZAID_ADMIN_2026") return alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ø³Ø± Ø®Ø§Ø·Ø¦Ø©!");
                    } else {
                        if(!roomPass) return alert("Ù‡Ø°Ù‡ ØºØ±ÙØ© Ø¬Ø¯ÙŠØ¯Ø©ØŒ ÙŠØ±Ø¬Ù‰ ØªØ¹ÙŠÙŠÙ† ÙƒÙ„Ù…Ø© Ø³Ø± Ù„Ù‡Ø§");
                        await db.ref('roomSettings/' + roomId).set({ password: btoa(roomPass) });
                    }
                }
                setIsLoggedIn(true);
                startChatSync();
            };

            const startChatSync = () => {
                // Ù…Ø²Ø§Ù…Ù†Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„
                db.ref('chats/' + roomId).on('child_added', snap => {
                    const msg = snap.val();
                    setMessages(prev => [...prev, msg]);
                    if (msg.senderId !== myPeerId) notificationSound.play().catch(()=>{});
                });

                // Ù…Ø²Ø§Ù…Ù†Ø© Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© (Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙ‚Ø· - Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³Ø§Ø¹Ø¯ Ø°ÙƒÙŠ)
                db.ref('typing/' + roomId).on('value', snap => {
                    const data = snap.val() || {};
                    const activeTyper = Object.entries(data).find(([id, val]) => id !== myPeerId && val.isTyping);
                    setTyper(activeTyper ? activeTyper[1].name : "");
                });
            };

            const sendMsg = (text) => {
                if(!text.trim()) return;
                const time = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                db.ref('chats/' + roomId).push({ text, time, senderName: myName, senderId: myPeerId });
                setInputValue("");
                updateTyping(false);
            };

            const updateTyping = (status) => {
                if (isLoggedIn) {
                    db.ref(`typing/${roomId}/${myPeerId}`).set({ name: myName, isTyping: status });
                }
            };

            // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„
            if (!isLoggedIn) return (
                <div className="flex items-center justify-center h-screen p-6">
                    <div className="glass-panel p-10 rounded-[40px] w-full max-w-sm text-center">
                        <div className="mb-4 inline-flex p-4 bg-yellow-500/10 rounded-full"><i className="fas fa-crown text-4xl text-yellow-500"></i></div>
                        <h2 className="text-3xl font-black text-white mb-2 uppercase tracking-tighter">ZAID CHAT <span className="text-yellow-500">PRO</span></h2>
                        <p className="text-gray-500 text-[10px] mb-8 uppercase tracking-widest">Ø£Ù†Øª Ø§Ù„Ø¢Ù† ÙÙŠ Ø§Ù„ØºØ±ÙØ©: {roomId}</p>
                        <div className="space-y-4 text-right">
                            <input className="w-full p-4 bg-white/5 rounded-2xl outline-none border border-white/10 text-white focus:border-yellow-500 transition-all" 
                                   placeholder="Ø§Ø³Ù…Ùƒ Ø§Ù„Ù…Ø³ØªØ¹Ø§Ø±" onChange={e=>setMyName(e.target.value)} />
                            {roomId !== 'Ø¹Ø§Ù…Ø©' && <input className="w-full p-4 bg-white/5 rounded-2xl outline-none border border-white/10 text-white focus:border-yellow-500 transition-all" 
                                                        type="password" placeholder="ÙƒÙ„Ù…Ø© Ø³Ø± Ø§Ù„ØºØ±ÙØ©" onChange={e=>setRoomPass(e.target.value)} />}
                            <button onClick={handleLogin} className="w-full send-btn-fixed !w-full !rounded-2xl font-bold mt-4">Ø¯Ø®ÙˆÙ„ Ø¢Ù…Ù†</button>
                            <button onClick={() => {
                                const n = prompt("Ø§Ø³Ù… Ø§Ù„ØºØ±ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:");
                                if(n) window.location.search = `?room=${encodeURIComponent(n)}`;
                            }} className="w-full text-gray-500 text-[10px] py-2 hover:text-white transition-all">
                                <i className="fas fa-plus-circle ml-1"></i> Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø­Ø§Ø¯Ø«Ø© Ø®Ø§ØµØ© Ø¨ÙƒÙ„Ù…Ø© Ø³Ø±
                            </button>
                        </div>
                    </div>
                </div>
            );

            // ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯Ø±Ø¯Ø´Ø©
            return (
                <div className="flex flex-col h-screen max-w-lg mx-auto bg-[#020617] relative shadow-2xl">
                    {/* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ù…Ø­Ø³Ù† */}
                    <div className="glass-panel m-4 p-4 rounded-3xl flex justify-between items-center z-50">
                        <div className="flex items-center gap-3">
                            <button onClick={()=>window.location.search=""} className="text-red-500 bg-red-500/10 w-10 h-10 rounded-xl flex items-center justify-center"><i className="fas fa-power-off"></i></button>
                            <div>
                                <h1 className="font-bold text-sm tracking-tight">ØºØ±ÙØ© {roomId}</h1>
                                <div className="flex items-center gap-1.5"><span className="w-2 h-2 bg-green-500 rounded-full animate-pulse"></span><span className="text-[10px] text-green-500 font-bold uppercase tracking-widest">Online</span></div>
                            </div>
                        </div>
                        <div className="flex gap-2">
                            <button onClick={async()=>{
                                const id=prompt("Ø£Ø¯Ø®Ù„ ID Ø§Ù„Ø·Ø±Ù Ø§Ù„Ø¢Ø®Ø± Ù„Ù„Ø§ØªØµØ§Ù„:");
                                if(id){
                                    const s=await navigator.mediaDevices.getUserMedia({video:true, audio:true});
                                    setStream(s); const call=peerRef.current.call(id, s);
                                    call.on('stream', rs=>setRemoteStream(rs));
                                }
                            }} className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-blue-400 border border-white/5"><i className="fas fa-video text-sm"></i></button>
                            <button onClick={()=>{navigator.clipboard.writeText(myPeerId); alert("ØªÙ… Ù†Ø³Ø® ID Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ!")}} 
                                    className="w-10 h-10 rounded-xl bg-white/5 flex items-center justify-center text-yellow-500 border border-white/5"><i className="fas fa-fingerprint text-sm"></i></button>
                        </div>
                    </div>

                    {/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ */}
                    <div className="flex-1 overflow-y-auto px-5 space-y-6 no-scrollbar pb-36 pt-4 flex flex-col">
                        {messages.map((m, i) => (
                            <div key={i} className={`max-w-[85%] p-4 shadow-xl ${m.senderId === myPeerId ? "my-msg" : "other-msg"}`}>
                                <div className="flex justify-between items-center mb-1 gap-4">
                                    <span className="text-[10px] font-bold text-yellow-500/80 uppercase tracking-tighter">{m.senderName}</span>
                                    {m.senderId === myPeerId && <i className="fas fa-check-double text-[8px] text-white/40"></i>}
                                </div>
                                <p className="text-[15px] leading-relaxed">{m.text}</p>
                                <span className="text-[8px] opacity-40 block mt-2 text-left font-mono">{m.time}</span>
                            </div>
                        ))}
                        
                        {/* Ù…Ø¤Ø´Ø± Ø¬Ø§Ø±ÙŠ Ø§Ù„ÙƒØªØ§Ø¨Ø© Ø¨ÙŠÙ† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† */}
                        {typer && (
                            <div className="other-msg p-3 flex flex-col items-start bg-blue-900/10 border-none animate-pulse">
                                <span className="text-[10px] font-bold text-blue-400 mb-1">{typer} ÙŠÙƒØªØ¨ Ø§Ù„Ø¢Ù†...</span>
                                <div className="flex gap-1">
                                    <span className="dot"></span><span className="dot"></span><span className="dot"></span>
                                </div>
                            </div>
                        )}
                        <div ref={scrollRef} />
                    </div>

                    {/* Ù†Ø§ÙØ°Ø© Ø§Ù„ÙÙŠØ¯ÙŠÙˆ */}
                    {remoteStream && (
                        <div className="video-overlay">
                            <video ref={el=>el&&(el.srcObject=remoteStream)} autoPlay className="w-full h-full object-cover" />
                            {stream && <video ref={el=>el&&(el.srcObject=stream)} autoPlay muted className="user-preview" />}
                            <button onClick={()=>{stream?.getTracks().forEach(t=>t.stop()); setStream(null); setRemoteStream(null)}} 
                                    className="absolute bottom-12 left-1/2 -translate-x-1/2 bg-red-600 w-16 h-16 rounded-full flex items-center justify-center shadow-2xl">
                                <i className="fas fa-phone-slash text-white text-xl"></i>
                            </button>
                        </div>
                    )}

                    {/* Ù…Ù†Ø·Ù‚Ø© Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ ÙˆØ²Ø± Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø«Ø§Ø¨Øª */}
                    <div className="fixed bottom-0 left-0 right-0 p-6 bg-gradient-to-t from-[#020617] via-[#020617]/80 to-transparent">
                        <div className="max-w-lg mx-auto flex gap-3 items-center">
                            <div className="glass-panel flex-1 flex items-center rounded-2xl px-4 border border-white/10 shadow-inner">
                                <button onClick={()=>alert("Ù‚Ø±ÙŠØ¨Ø§Ù‹: Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØµÙˆØ±")} className="p-2 text-yellow-500/50"><i className="fas fa-image"></i></button>
                                <input 
                                    className="flex-1 bg-transparent py-5 outline-none text-white text-sm" 
                                    placeholder="Ø§ÙƒØªØ¨ Ø±Ø³Ø§Ù„ØªÙƒ Ø§Ù„Ù…Ù„ÙƒÙŠØ©..." 
                                    value={inputValue} 
                                    onChange={(e) => {
                                        setInputValue(e.target.value);
                                        updateTyping(e.target.value.length > 0);
                                    }} 
                                    onBlur={() => updateTyping(false)}
                                    onKeyPress={(e) => e.key === 'Enter' && sendMsg(inputValue)} 
                                />
                            </div>
                            <button onClick={() => sendMsg(inputValue)} className="send-btn-fixed">
                                <i className="fas fa-paper-plane text-xl ml-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            );
        }
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>